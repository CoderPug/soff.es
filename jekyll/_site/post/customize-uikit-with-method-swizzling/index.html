<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="content-type" content="text/html;charset=utf-8" />
    <title>samsoff.es - Customize UIKit with Method Swizzling</title>
    <link href="http://feeds.feedburner.com/samsoffes/blog" rel="alternate" title="samsoff.es" type="application/atom+xml" />
    <link href="http://feeds.feedburner.com/samsoffes/the-experiment" rel="alternate" title="The Experiment Podcast" type="application/atom+xml" />
    <link href="/stylesheets/application.css" media="screen" rel="stylesheet" type="text/css" />
    <link href="/stylesheets/iphone.css" media="only screen and (max-device-width: 480px)" rel="stylesheet" type="text/css" />
    <link rel="me" href="http://www.google.com/profiles/samsoffes" />
    <meta name="viewport" content="width=320, user-scalable=no" />
    <script src="/javascripts/application.js"></script>
    <script>var _gaq=_gaq || [];_gaq.push(['_setAccount','UA-5609322-1']);_gaq.push(['_trackPageview']);(function(){var ga=document.createElement('script');ga.async=true;ga.src=('https:'==document.location.protocol?'https://ssl':'http://www')+'.google-analytics.com/ga.js';(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ga);})();</script>
  </head>
  <body>
    <div id="border"></div>
    <div class="wrapper">
    	<div id="header" class="clear">
    		<h1><a href="/">sam<span>soff.es</span></a></h1>
    		<div>
      		<ul class="clear">
      			<li class="blog"><a href="/">Blog</a></li>
      			<li class="music"><a href="/music">Music</a></li>
      			<li class="about"><a href="/about">About</a></li>
      		</ul>
      	</div>
    	</div>
    	    	
      
<div class="post">
  <div class="title">
    <h2><a href="/post/customize-uikit-with-method-swizzling">Customize UIKit with Method Swizzling</a></h2>
    <p class="meta">Posted 12 Nov 2009</p>
  </div>
  <div class="content">
    <p>Have you ever wanted to override some functionality in UIKit that was in a hard to reach place? A lot of applications on the App Store have custom <code>UINavigationBar</code>'s. I really wanted to do this one of <a href="http://tastefulworks.com">my company</a>'s upcoming apps.</p>

<p>A popular solution for this creating a category and overriding the method you want to change in it. For this the example, we'll make a <code>UINavigationBar</code> green instead (obviously you could do something cool here instead). The category way would look something like this:</p>

<div class="highlight"><pre><code class="c"><span class="err">@</span><span class="n">interface</span> <span class="n">UINavigationBar</span> <span class="p">(</span><span class="n">CustomBackground</span><span class="p">)</span>
<span class="err">@</span><span class="n">end</span>


<span class="err">@</span><span class="n">implementation</span> <span class="n">UINavigationBar</span> <span class="p">(</span><span class="n">CustomBackground</span><span class="p">)</span>

<span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">drawRect</span><span class="o">:</span><span class="p">(</span><span class="n">CGRect</span><span class="p">)</span><span class="n">rect</span> <span class="p">{</span>
    <span class="p">[[</span><span class="n">UIColor</span> <span class="n">greenColor</span><span class="p">]</span> <span class="n">set</span><span class="p">];</span>
    <span class="n">CGRect</span> <span class="n">fillRect</span> <span class="o">=</span> <span class="n">CGRectMake</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">height</span><span class="p">);</span>
    <span class="n">CGContextFillRect</span><span class="p">(</span><span class="n">UIGraphicsGetCurrentContext</span><span class="p">(),</span> <span class="n">fillRect</span><span class="p">);</span>
<span class="p">}</span>

<span class="err">@</span><span class="n">end</span>
</code></pre>
</div>


<p>This approach works very well, but there are two issues with it: overriding methods with a category is an Objective-C no no and if you need to call the default implementation, you can't.</p>

<p>In my app, I wanted to change most of the navigation bars in all of the navigation controllers. I am using a <code>UIImagePickerController</code> in part of the app and it was customized to. I really wanted to keep it the translucent style instead of the style for the rest of my app.</p>

<p>I decided any <code>UINavigationBar</code> with <code>UIBarStyleDefault</code> as its style, I want to override and everything else leave alone. There is no way to do this with the category approach. You can't call <code>[self drawRect:rect]</code> because it would infinitely call itself since you replaced it with the method you are calling it from.</p>

<h3>Method swizzling</h3>

<p>After some googling and some help from #macdev on Freenode, I changed my solution to use method swizzling. <a href="http://www.cocoadev.com/index.pl?MethodSwizzling">Method swizzling</a>, in short, is switching methods at runtime. So you can say for <code>UINavigationBar</code> don't use the standard <code>drawRect:</code>, but instead swap it with a different one. (This is kinda confusing, but hang in there. It's not that hard.)</p>

<p>I updated my category to look like this:</p>

<div class="highlight"><pre><code class="c"><span class="err">@</span><span class="n">interface</span> <span class="n">UINavigationBar</span> <span class="p">(</span><span class="n">CustomBackground</span><span class="p">)</span>
<span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">drawRectCustomBackground</span><span class="o">:</span><span class="p">(</span><span class="n">CGRect</span><span class="p">)</span><span class="n">rect</span><span class="p">;</span>
<span class="err">@</span><span class="n">end</span>


<span class="err">@</span><span class="n">implementation</span> <span class="n">UINavigationBar</span> <span class="p">(</span><span class="n">CustomBackground</span><span class="p">)</span>

<span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">drawRectCustomBackground</span><span class="o">:</span><span class="p">(</span><span class="n">CGRect</span><span class="p">)</span><span class="n">rect</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">barStyle</span> <span class="o">==</span> <span class="n">UIBarStyleDefault</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">[[</span><span class="n">UIColor</span> <span class="n">greenColor</span><span class="p">]</span> <span class="n">set</span><span class="p">];</span>
        <span class="n">CGRect</span> <span class="n">fillRect</span> <span class="o">=</span> <span class="n">CGRectMake</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">height</span><span class="p">);</span>
        <span class="n">CGContextFillRect</span><span class="p">(</span><span class="n">UIGraphicsGetCurrentContext</span><span class="p">(),</span> <span class="n">fillRect</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="c1">// Call default implementation</span>
    <span class="p">[</span><span class="n">self</span> <span class="n">drawRectCustomBackground</span><span class="o">:</span><span class="n">rect</span><span class="p">];</span>
<span class="p">}</span>

<span class="err">@</span><span class="n">end</span>
</code></pre>
</div>


<p>I then updated <code>main.m</code> to look like this:</p>

<div class="highlight"><pre><code class="c"><span class="cp">#import &lt;objc/runtime.h&gt;</span>
<span class="cp">#import &quot;UINavigationBar+CustomBackground.h&quot;</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
    <span class="n">NSAutoreleasePool</span> <span class="o">*</span> <span class="n">pool</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NSAutoreleasePool</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>

    <span class="c1">// Swizzle the nav bar</span>
    <span class="n">Method</span> <span class="n">drawRectCustomBackground</span> <span class="o">=</span> <span class="n">class_getInstanceMethod</span><span class="p">([</span><span class="n">UINavigationBar</span> <span class="n">class</span><span class="p">],</span> <span class="err">@</span><span class="n">selector</span><span class="p">(</span><span class="n">drawRectCustomBackground</span><span class="o">:</span><span class="p">));</span>
    <span class="n">Method</span> <span class="n">drawRect</span> <span class="o">=</span> <span class="n">class_getInstanceMethod</span><span class="p">([</span><span class="n">UINavigationBar</span> <span class="n">class</span><span class="p">],</span> <span class="err">@</span><span class="n">selector</span><span class="p">(</span><span class="n">drawRect</span><span class="o">:</span><span class="p">));</span>
    <span class="n">method_exchangeImplementations</span><span class="p">(</span><span class="n">drawRect</span><span class="p">,</span> <span class="n">drawRectCustomBackground</span><span class="p">);</span>

    <span class="kt">int</span> <span class="n">retVal</span> <span class="o">=</span> <span class="n">UIApplicationMain</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="n">nil</span><span class="p">,</span> <span class="err">@</span><span class="s">&quot;AppDelegate&quot;</span><span class="p">);</span>

    <span class="p">[</span><span class="n">pool</span> <span class="n">release</span><span class="p">];</span>
    <span class="k">return</span> <span class="n">retVal</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
</div>


<p>So this kinda hurt my head when I was first looking at all of this. In <code>main.m</code>, before the application starts, I swizzle the <code>UINavigationBar</code> methods. <code>method_exchangeImplementations()</code> switches my <code>drawRectCustomBackground:</code> with <code>drawRect:</code> in
<code>UINavigationBar</code>. When I call the default implementation in <code>drawRectCustomBackground:</code>, it looks like I'm calling the same method, but I am actually calling the default implementation because it swapped them.</p>

<p>This is pretty crazy and a little confusing (especially with someone new to Objective-C), but really powerful. You can use this approach to customize a lot of things Apple didn't intend for you to mess with. Go out and make something cool!</p>

  </div>
</div>



    </div>
    <div id="footer" class="wrapper">
    	<p class="clear">
    	    <span>Copyright <a href="/">Sam Soffes</a> 2005-2010.</span>
    	    <span><a href="http://github.com/samsoffes/samsoff.es" target="_blank" rel="external nofollow">View source on GitHub</a>.</span>
      </p>
    </div>
  </body>
</html>
